(function($) {
    'use strict';

    $(function() {

        // Common classes
        let body = $('body');
        let selectFields = $('.api-launch-search');
        let listSelect = $('select[name="race_list"]');

        // Engaged search
        let engagedFormRaces = $('#engaged-search-courses');

        // Podium search
        let podiumForm = $('#podium-filters');

        // Ranking search
        let rankingSubmit = $('.ranking-submit');
        let rankingForm = $('#ranking-search');
        let wrapperRanking = $('.api-ranking-results');
        let loadingMessage = $('.tech-loading-ranking');
        let loadMoreButton = $('.tech-load-more-ranking');
        let resetSearch = $('#api-reset-search');
        let inputSearch = $('#api-search-input');
        let teamsDivision = $('.tech-teams-division');
        $(loadingMessage).hide();

        // Search
        rankingSubmit.on('click', function(e) {
            e.preventDefault();
            // Launch search
            rankingSearch(rankingForm.data('ranking-type'), rankingForm.serialize());
        });

        // Refresh the single race engaged when the list select is changing
        listSelect.on('change', function(e) {
            window.location.replace(window.location.href.split('?')[0] + '?list_id=' + listSelect.val() + '#liste-engages');
        });

        selectFields.on('change', function(e) {
            // On the single race, there is a select with the race_list name
            let listID = listSelect.val();

            // On the results page the list ID is displayed on top of the podium
            if ( listID < 1 ) {
                listID = engagedFormRaces.data('list-id');
            }

            if(body.hasClass('single-courses')){
                // Launch search - engaged
                engagedSearch(engagedFormRaces.data('race-id'), listID, engagedFormRaces.serialize(), engagedFormRaces.data('headers'));
            }else if(body.hasClass('single-resultats')){
                // Launch search - podium
                podiumSearch(podiumForm.data('race-id'), podiumForm.serialize());
            }else if(body.hasClass('single-classement-national')){
                // Launch search - ranking
                rankingSearch(rankingForm.data('ranking-type'), rankingForm.serialize());
            }
        });

        // Reset search
        resetSearch.on('click', function(e){
            e.preventDefault();
            // Reset filters
            selectFields.val('').trigger('change');
            inputSearch.val('').trigger('change');
            // Launch search
            rankingSearch(rankingForm.data('ranking-type'), null);
        });

        if ($('body').hasClass('single-classement-national')) {
            let rankingTable = $('.ranking-table').DataTable({
                lengthChange: false,
                searching: false,
                ordering: false,
                paging: false,
                autoWidth: false,
                responsive: true,
                info: false
            });

            // Load more
            loadMoreButton.on('click', function(e) {
                rankingTable.destroy()

                e.preventDefault();

                $(this).hide();
                loadingMessage.show();

                let page = loadMoreButton.data('page');
                let type = loadMoreButton.data('ranking-type');
                let searchData = rankingForm.serialize();

                $.post(
                    ajaxurl,
                    {
                        'action' : 'api_ranking_load_more',
                        'type' : type,
                        'form_data' : searchData,
                        'current_page' : page
                    },
                    function(response) {
                        response = JSON.parse(response);
                        if(response.load_more){
                            loadMoreButton.show();
                        }
                        loadingMessage.hide();
                        loadMoreButton.data('page', page + 1);

                        $('.ranking-table tr:last').after(response.html);

                        rankingTable = $('.ranking-table').DataTable({
                            lengthChange: false,
                            searching: false,
                            ordering: false,
                            paging: false,
                            autoWidth: false,
                            responsive: true,
                            info: false
                        });
                    }
                );
            });
        }

        // Display selected division
        if ($('body').hasClass('post-type-archive-equipes')) {
            $(document).on('facetwp-loaded', function(){
                if ( undefined === FWP.facets['divisions'][0]) {
                    teamsDivision.html('divisions nationales');
                } else {
                    teamsDivision.html((FWP.facets['divisions'][0]).toUpperCase());
                }
            });
        }

        /**
         * Ranking search AJAX action
         * @param rankingType
         * @param data
         */
        function rankingSearch(rankingType, data) {
            $.post(
                ajaxurl,
                {
                    'action' : 'api_ranking_search',
                    'type' : rankingType,
                    'form_data' : data
                },
                function(response) {
                    response = JSON.parse(response);
                    if(!response.load_more){
                        loadMoreButton.hide();
                    }
                    wrapperRanking.html(response.html);
                }
            );
        }

        /**
         * Engaged search AJAX action
         * @param raceId
         * @param listId
         * @param data
         * @param headers
         */
        function engagedSearch(raceId, listId, data, headers) {
            let engageBody = $('.engage-table-body');

            $.post(
                ajaxurl,
                {
                    'action' : 'api_engaged_search',
                    'race_id' : raceId,
                    'list_id' : listId,
                    'form_data' : data,
                    'headers' : JSON.stringify(headers)
                },
                function(response) {
                    engageBody.html(engageBody.find('tr:first')[0].outerHTML + response);
                }
            );
        }

        /**
         * Podium search AJAX action
         * @param raceId
         * @param listId
         * @param data
         */
        function podiumSearch(raceId, data) {
            let podiumWrapper = $('.podium-filters-result');
            let rankingWrapper = $('.result-list-engaged');

            $.post(
                ajaxurl,
                {
                    'action' : 'api_podium_search',
                    'race_id' : raceId,
                    'form_data' : data
                },
                function(response) {
                    podiumWrapper.html(JSON.parse(response).podium);
                    rankingWrapper.html(JSON.parse(response).ranking);
                }
            );
        }
    });

})(jQuery);
